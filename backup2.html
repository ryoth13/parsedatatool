<!DOCTYPE html>
<html>
  <head>
    <title>数据解析</title>
    <style>
          body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      color: #333;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
    }

    h1 {
      
      font-size: 28px;
      margin: 0;
    }

    .content {
      max-width: 800px;
      width: 100%;
      background-color: #fff;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 20px;
      box-sizing: border-box;
      position: relative;
    }

    .input-container {
      margin-bottom: 20px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    label {
      font-weight: bold;
      
      margin-bottom: 10px;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      font-family: "Arial", sans-serif;
      resize: vertical;
    }

    .parse-button {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
    }

    button {
      padding: 8px 16px;
      background-color: #4caf50;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #45a049;
    }

    table {
      table-layout: fixed;
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      border: 1px solid #ccc;
    }

    th,
    td {
      word-wrap: break-word;
      max-width: 200px;
      /* 可根据需要调整最大宽度 */
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
      /* 垂直居中 */
    }

    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    @media (max-width: 600px) {
      .content {
        padding: 10px;
      }
    }

    /* 深色模式 */
    body.dark-mode {
      background-color: #333;
      color: #f5f5f5;
    }

    body.dark-mode .content {
      background-color: #444;
    }

    body.dark-mode th {
      background-color: #555;
    }

    body.dark-mode tr:nth-child(even) {
      background-color: #666;
    }

    /* 主题切换开关按钮 */
    #theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    #theme-toggle:hover {
      background-color: #f2f2f2;
    }

    #theme-toggle::before {
      content: "";
      display: block;
      width: 24px;
      height: 24px;
      background-image: url('sun-icon.png');
      background-repeat: no-repeat;
      background-size: cover;
      transition: transform 0.3s;
    }

    body.dark-mode #theme-toggle::before {
      transform: rotate(180deg);
      background-image: url('moon-icon.png');
    }
  </style>
    
  <body>
    <div class="container">
      <div class="header">
        <h1>数据解析</h1>
      </div>
  
      <div class="content" rows="8">
        <div class="input-container">
          <label for="inputData">输入数据：</label><br />
          <textarea id="inputData" rows="4" placeholder="请输入数据"></textarea>
        </div>
  
        <div class="parse-button">
          <button onclick="parseData()">解析</button>
        </div>
  
        <div id="outputData"></div>
      </div>
    </div>
  
    <div id="theme-toggle" onclick="toggleDarkMode()"></div>
    <script>
      // 检查设备是否支持prefers-color-scheme
      function checkPrefersColorScheme() {
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      }
  
      // 切换深色模式和浅色模式
      function toggleDarkMode() {
        const body = document.querySelector('body');
        body.classList.toggle('dark-mode');
      }
  
      // 根据设备的深色模式设置初始主题
      function setInitialTheme() {
        const prefersDarkMode = checkPrefersColorScheme();
        const body = document.querySelector('body');
  
        if (prefersDarkMode) {
          body.classList.add('dark-mode');
        }
      }
  
      // 解析数据的函数
      function parseData() {
        // 解析逻辑
      }
      function parseData() {
        var inputData = document.getElementById("inputData").value;

        var result = "<table>";
        result += "<tr><th>类型</th><th>数据</th><th>解析</th></tr>";

        // 第一行：起始符
        var start = inputData.slice(0, 4);
        result += "<tr><td>起始符</td><td>" + start + "</td><td>";
        if (start === "ABCD") {
          result += "起始符(ABCD)";
        } else {
          result += "ERROR";
        }
        result += "</td></tr>";

        // 第二行：帧长度
        var frameLength = inputData.slice(4, 8);
        var frameLengthDecimal = parseInt(frameLength, 16);
        result +=
          "<tr><td>帧长度</td><td>" +
          frameLength +
          "</td><td>" +
          "帧长度" +
          frameLengthDecimal +
          "</td></tr>";

        // 第三行：站号
        var stationNumber = inputData.slice(8, 12);
        var stationNumberDecimal = parseInt(stationNumber, 16);
        result +=
          "<tr><td>站号</td><td>" +
          stationNumber +
          "</td><td>" +
          "站号" +
          stationNumberDecimal +
          "</td></tr>";

        // 第四行：起始时间
        var startTime = inputData.slice(12, 22);
        var year = startTime.slice(0, 2);
        var month = startTime.slice(2, 4);
        var day = startTime.slice(4, 6);
        var hour = startTime.slice(6, 8);
        var minute = startTime.slice(8, 10);
        var second = startTime.slice(10, 12);
        result +=
          "<tr><td>起始时间</td><td>" +
          startTime +
          "</td><td>" +
          year +
          "年" +
          month +
          "月" +
          day +
          "日" +
          hour +
          "时" +
          minute +
          "分</td></tr>";

        // 第五行：数据个数
        var dataCount = inputData.slice(22, 24);
        var dataCountDecimal = parseInt(dataCount, 16);
        result +=
          "<tr><td>数据个数</td><td>" +
          dataCount +
          "</td><td>" +
          "数据个数" +
          dataCountDecimal +
          "个" +
          "</td></tr>";

        // 第六行：数据间隔
        var dataInterval = inputData.slice(24, 26);
        var dataIntervalDecimal = parseInt(dataInterval, 16);
        result +=
          "<tr><td>数据间隔</td><td>" +
          dataInterval +
          "</td><td>" +
          "数据间隔" +
          dataIntervalDecimal +
          "分钟" +
          "</td></tr>";

        // 第七行：电池电压
        var batteryVoltage = inputData.slice(26, 30);
        var batteryVoltageDecimal = (
          parseInt(batteryVoltage, 16) / 100
        ).toFixed(2);
        result +=
          "<tr><td>电池电压</td><td>" +
          batteryVoltage +
          "</td><td>" +
          batteryVoltageDecimal +
          "V" +
          "</td></tr>";

        // 第八行：发送次数
        var sendCount = inputData.slice(30, 34);
        var sendCountDecimal = parseInt(sendCount, 16);
        result +=
          "<tr><td>发送次数</td><td>" +
          sendCount +
          "</td><td>" +
          sendCountDecimal +
          "次" +
          "</td></tr>";

        // 第九行：信号强度
        var signalStrength = inputData.slice(34, 36);
        var signalStrengthDecimal = parseInt(signalStrength, 16);
        var signalResult = "";
        if (signalStrengthDecimal === 99) {
          signalResult = "WARNING!--信道无效";
        } else if (signalStrengthDecimal >= 1 && signalStrengthDecimal <= 31) {
          signalResult = signalStrengthDecimal.toString();
        } else {
          signalResult = "ERROR--信号指示有效值1-31";
        }
        result +=
          "<tr><td>信号强度</td><td>" +
          signalStrength +
          "</td><td>" +
          signalResult +
          "</td></tr>";

        // 第十行：设备信息
        var deviceInfo = inputData.slice(36, 76);
        var deviceName = String.fromCharCode(
          parseInt(deviceInfo.substr(0, 2), 16),
          parseInt(deviceInfo.substr(2, 2), 16),
          parseInt(deviceInfo.substr(4, 2), 16),
          parseInt(deviceInfo.substr(6, 2), 16),
          parseInt(deviceInfo.substr(8, 2), 16)
        );

        var hardwareVersion = String.fromCharCode(
          parseInt(deviceInfo.substr(10, 2), 16),
          parseInt(deviceInfo.substr(12, 2), 16),
          parseInt(deviceInfo.substr(14, 2), 16),
          parseInt(deviceInfo.substr(16, 2), 16),
          parseInt(deviceInfo.substr(18, 2), 16),
          parseInt(deviceInfo.substr(20, 2), 16),
          parseInt(deviceInfo.substr(22, 2), 16)
        );

        var softwareVersion = String.fromCharCode(
          parseInt(deviceInfo.substr(24, 2), 16),
          parseInt(deviceInfo.substr(26, 2), 16),
          parseInt(deviceInfo.substr(28, 2), 16),
          parseInt(deviceInfo.substr(30, 2), 16),
          parseInt(deviceInfo.substr(32, 2), 16),
          parseInt(deviceInfo.substr(34, 2), 16),
          parseInt(deviceInfo.substr(36, 2), 16),
          parseInt(deviceInfo.substr(38, 2), 16)
        );
        result +=
          "<tr><td>设备信息</td><td>" +
          deviceInfo +
          "</td><td>" +
          "<br>设备名称: " +
          deviceName +
          "<br>硬件版本: " +
          hardwareVersion +
          "<br>软件版本: " +
          softwareVersion +
          "</td></tr>";

        // 第十一行：保留八字节
        var reservedData = inputData.slice(76, 92);
        var thirdTableCell =
          reservedData === "0000000000000000" ? "预留" : "ERROR";
        result +=
          "<tr><td>保留八字节</td><td>" +
          reservedData +
          "</td><td>" +
          thirdTableCell +
          "</td></tr>";

        // 第十二行：DATA
        var dataIndex = (parseInt(frameLength, 16) - 43) * 2;
        var data = inputData.slice(92, 92 + dataIndex);
        result += "<tr><td>DATA</td><td>" + data + "</td><td>见解析</td></tr>";

        // 首先，将data从十六进制字符串转换为Uint8Array
        var dataBytes = new Uint8Array(data.length / 2);
        for (var i = 0; i < data.length; i += 2) {
          dataBytes[i / 2] = parseInt(data.substr(i, 2), 16);
        }

        // 然后，调用解析函数
        var parsedData = parseDataContent(dataBytes);

        // 插入解析结果到HTML表格
        result += parsedData;
        // 第十三行：CS
        var cs = inputData.slice(92 + dataIndex, 94 + dataIndex);
        var dataForChecksum = inputData.replace(/\s/g, "").slice(0, -6); // 去除最后六位数
        var checksum = calculateChecksum(dataForChecksum); // 调用计算累加和的函数，传入去除最后六位数的数据
        result +=
          "<tr><td>CS</td><td>" +
          cs +
          "</td><td>CS应为：" +
          checksum +
          "</td></tr>";
        // 第十四行：结束符
        var end = inputData.slice(94 + dataIndex, 98 + dataIndex);
        result += "<tr><td>结束符</td><td>" + end + "</td><td>";
        if (end === "0D0A") {
          result += "结束符(0D0A)";
        } else {
          result += "ERROR";
        }
        result += "</td></tr>";

        result += "</table>";

        document.getElementById("outputData").innerHTML = result;
      }
      // 数据类型枚举
      var DataType = {
        Type01: 0x01,
        Type02: 0x02,
        Type03: 0x03,
        Type04: 0x04,
        Type05: 0x05,
        Type06: 0x06,
      };
      //计算CS
      function calculateChecksum(data) {
        var sum = 0;
        for (var i = 0; i < data.length; i += 2) {
          var hexByte = data.substr(i, 2);
          sum += parseInt(hexByte, 16);
        }
        var checksum = sum % 256;
        return checksum.toString(16).toUpperCase();
      }

      // 数据结构体
      function Data(type, channel, data, data_len) {
        this.type = type; // 数据类型
        this.channel = channel; // 通道号
        this.data = data; // 数据指针
        this.data_len = data_len; // 数据长度
      }

      // 获取下一条数据的起始位置
      function getNextDataPos(buf, buf_len, pos) {
        // 找到下一个类型+通道号的组合
        while (pos < buf_len - 2) {
          if (
            (buf[pos] === DataType.Type01 ||
              buf[pos] === DataType.Type02 ||
              buf[pos] === DataType.Type03 ||
              buf[pos] === DataType.Type04 ||
              buf[pos] === DataType.Type05 ||
              buf[pos] === DataType.Type06) &&
            buf[pos + 1] > 0
          ) {
            return pos;
          }
          pos++;
        }
        return buf_len;
      }

      // 获取数据类型对应的数据长度
      function getDataLen(type) {
        switch (type) {
          case DataType.Type01:
            return 4;
          case DataType.Type02:
            return 1;
          case DataType.Type03:
            return 1;
          case DataType.Type04:
            return 4;
          case DataType.Type05:
            return 2;
          case DataType.Type06:
            return 4;
          default:
            return 0;
        }
      }

      // 解析数据内容
      function parseDataContent(buf) {
        var buf_len = buf.length;
        var pos = 0;
        var result = "";

        while (pos < buf_len) {
          var data = parseDataHelper(buf, buf_len, pos);
          if (!data) {
            break;
          }
          var typeChannel = data.type.toString(16) + data.channel;
          var combinationResult = getCombinationResult(data, buf, pos);
          var parsedData = parseDataAnalysis(combinationResult, data.type);
          result +=
            "<tr><td>" +
            typeChannel +
            "</td><td>" +
            combinationResult +
            "</td><td>" +
            parsedData +
            "</td></tr>\n";

          pos = getNextDataPos(buf, buf_len, pos + 2 + data.data_len); // 跳过当前数据
        }

        return result;
      }

      // 获取类型+通道号组合的所有数字
      function getCombinationResult(data, buf, pos) {
        var combinationResult = ""; // 存储类型+通道号组合的所有数字
        for (var i = 0; i < data.data_len; i++) {
          combinationResult += data.data[i].toString(16).padStart(2, "0");
        }
        // 添加 buf 中的数据到 combinationResult
        var next_pos = getNextDataPos(buf, buf.length, pos + 2 + data.data_len);
        for (var i = pos + 2 + data.data_len; i < next_pos; i++) {
          combinationResult += buf[i].toString(16).padStart(2, "0");
        }
        return combinationResult;
      }

      // 解析数据的辅助函数
      function parseDataHelper(buf, buf_len, pos) {
        var data_type = buf[pos];
        var channel = buf[pos + 1];
        var data_len = getDataLen(data_type);

        // 构造数据对象
        var data = new Data(data_type, channel, [], data_len);
        for (var i = 0; i < data_len; i++) {
          data.data.push(buf[pos + 2 + i]);
        }

        return data;
      }

      // 根据类型解析数据
      function parseDataAnalysis(combinationResult, dataType) {
        switch (dataType) {
          case 1:
            return parseAnalysis1Data(combinationResult);
          case 4:
            return parseAnalysis4Data(combinationResult);
          case 5:
            return parseAnalysis5Data(combinationResult);
          case 6:
            return parseAnalysis6Data(combinationResult);
          default:
            return "待解析";
        }
      }

      // 计算值
      function calculateValue(hexGroup) {
        var reversedHex = reverseHex(hexGroup);
        var decValue = hexToDecimal(reversedHex);
        return decValue;
      }

      // 解析类型1的数据
      function parseAnalysis1Data(combinationResult) {
        var result = "昨日数据："; // 初始值为 "昨日数据："
        var groups = splitIntoGroups(combinationResult, 8);
        var yesterdayData = groups.shift(); // 移除第一组数据并赋值给 yesterdayData

        result += parseGroupData(yesterdayData) + "m³";

        for (var i = 0; i < groups.length; i++) {
          result += " 数据" + (i + 1) + "：" + parseGroupData(groups[i]) + "m³";
        }

        return result;
      }

      // 将字符串按指定长度分组
      function splitIntoGroups(str, length) {
        var groups = [];
        for (var i = 0; i < str.length; i += length) {
          groups.push(str.slice(i, i + length));
        }
        return groups;
      }

      // 解析单个分组的数据
      function parseGroupData(group) {
        var reversedGroup = reverseGroup(group);
        var decValue = hexToDecimal(reversedGroup);
        return decValue;
      }

      // 反转分组的数据
      function reverseGroup(group) {
        var reversedGroup = "";
        for (var i = group.length - 2; i >= 0; i -= 2) {
          reversedGroup += group.slice(i, i + 2);
        }
        return reversedGroup;
      }

      // 解析类型4的数据
      function parseAnalysis4Data(combinationResult) {
        var result = "";
        var groups = SplitIntoGroups(combinationResult, 8);

        for (var i = 0; i < groups.length; i++) {
          var decimalValue = FHexToDecimal(groups[i]);
          decimalValue = decimalValue.toFixed(2); // 保留两位小数
          result += "数据" + (i + 1) + "：" + decimalValue + " ";
        }

        return result;
      }

      // 将字符串按指定长度分组
      function SplitIntoGroups(str, length) {
        var groups = [];
        for (var i = 0; i < str.length; i += length) {
          groups.push(str.slice(i, i + length));
        }
        return groups;
      }

      // 解析类型5的数据
      function parseAnalysis5Data(combinationResult) {
        var result = "";
        var groups = s5plitIntoGroups(combinationResult, 4);

        for (var i = 0; i < groups.length; i++) {
          var ReversedGroup = ReverseGroup(groups[i]);
          var binaryValue = hexToBinary(ReversedGroup);
          result += "数据" + (i + 1) + "：" + binaryValue + " ";
        }

        return result;
      }

      // 将字符串按指定长度分组
      function s5plitIntoGroups(str, length) {
        var groups = [];
        for (var i = 0; i < str.length; i += length) {
          groups.push(str.slice(i, i + length));
        }
        return groups;
      }

      // 反转分组的数据
      function ReverseGroup(group) {
        var ReversedGroup = "";
        for (var i = 2; i >= 0; i--) {
          ReversedGroup += group[i];
        }
        return ReversedGroup;
      }

      // 解析类型6的数据
      function parseAnalysis6Data(combinationResult) {
        return "表号：" + combinationResult;
      }

      // 反转十六进制字符串
      function reverseHex(hex) {
        var reversedHex = "";
        for (var i = hex.length - 2; i >= 0; i -= 2) {
          reversedHex += hex.substr(i, 2);
        }
        return reversedHex;
      }
      // 将十六进制转换为二进制
      function hexToBinary(hex) {
        var binary = "";
        for (var i = 0; i < hex.length; i++) {
          var decimal = parseInt(hex.charAt(i), 16);
          var binaryChunk = decimal.toString(2).padStart(4, "0");
          binary += binaryChunk;
        }
        return binary;
      }
      // 将十六进制字符串转换为十进制数值
      function hexToDecimal(hexString) {
        return parseInt(hexString, 16);
      }

      // 将十六进制字符串转换为浮点数
      function FHexToDecimal(hex) {
        var arr = new ArrayBuffer(4);
        var view = new DataView(arr);
        view.setUint32(0, parseInt(hex, 16), false);
        return view.getFloat32(0);
      }
      setInitialTheme();
    </script>
  
  </body>
</html>
